name: Blood Banking System CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-backend:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: Abhi@9142
          MYSQL_DATABASE: bloodbank
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: cd BloodBackend && mvn clean package -DskipTests
      
    - name: Run Tests
      run: cd BloodBackend && mvn test

    - name: Upload backend artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-artifact
        path: BloodBackend/target/*.war
        retention-days: 5

  build-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: bloodbankingsys/blood_banking_system-master/package.json
        
    - name: Install dependencies
      run: cd bloodbankingsys/blood_banking_system-master && npm install
      
    - name: Build frontend
      run: cd bloodbankingsys/blood_banking_system-master && npm run build
      
    - name: Upload frontend artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-artifact
        path: bloodbankingsys/blood_banking_system-master/dist
        retention-days: 5
  
  deploy:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-artifact
        path: backend-artifact
        
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-artifact
        path: frontend-artifact
    
    # Example deployment step for AWS
    # Uncomment and modify for your specific deployment needs
    # - name: Deploy to AWS
    #   uses: einaregilsson/beanstalk-deploy@v21
    #   with:
    #     aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
    #     aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}
    #     region: us-east-1
    #     application_name: blood-banking-system
    #     environment_name: Production
    #     version_label: ${{ github.run_number }}
    #     deployment_package: backend-artifact/*.war

    # Example deployment step for Azure
    # Uncomment and modify for your specific deployment needs
    # - name: Deploy to Azure
    #   uses: azure/webapps-deploy@v2
    #   with:
    #     app-name: blood-banking-system
    #     publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
    #     package: backend-artifact/*.war

    # Placeholder for deployment
    - name: Placeholder for deployment step
      run: |
        echo "Deployment would happen here in a real environment"
        echo "Backend artifact would be deployed to a Java application server"
        echo "Frontend artifact would be deployed to a web server or CDN"